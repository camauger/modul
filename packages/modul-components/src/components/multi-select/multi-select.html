<m-base-select class="m-multi-select"
               :class="{ 'm--is-open': open,
                'm--is-disabled': disabled,
                'm--is-waiting': waiting,
                'm--has-validation-message': hasValidationMessage }"
               :control-id="id"
               :active="!disabled && !readonly"
               :items="options"
               :selected-items="selectedItems"
               :open.sync="open"
               :input-max-width="inputMaxWidth"
               :close-on-select="false"
               :hide-radio-button-mobile="true"
               :enable-animation="!linkSelectAll"
               @select-item="onSelect"
               @close="onClose"
               ref="baseSelect">
    <template v-slot:default="scope">
        <div class="m-multi-select__input"
             :tabindex="disabled ? '-1' : '0'"
             @focus="onFocus"
             @blur="onBlur"
             @click="toggle"
             @keydown.up.prevent="onKeydownUp"
             @keydown.down.prevent="onKeydownDown"
             @keydown.enter.prevent="onKeydownEnter"
             @keydown.return.prevent="onKeydownEnter"
             @keydown.esc="scope.keyEsc"
             @keydown.tab="scope.keyTab"
             @keydown.space="onKeydownSpace"
             ref="input">
            <m-input-style :label="label"
                           :label-for="id"
                           :label-up="labelUp"
                           :disabled="disabled"
                           :readonly="readonly"
                           :waiting="waiting"
                           :focus="isFocus"
                           :empty="isEmpty"
                           :error="hasError"
                           :cursor-pointer="true"
                           :valid="isValid"
                           :required-marker="requiredMarker"
                           :tag-style="tagStyle"
                           :style="{ width: inputWidth, maxWidth: inputMaxWidth }">
                <m-chip-delete v-if="chipsDisplayMode === 1"
                               class="m-multi-select__chip"
                               size="small"
                               :disabled="disabled"
                               :readonly="readonly"
                               @delete="onDeleteAll()">
                    <template v-slot:default>
                        <slot name="chips-all">
                            <m-i18n k="m-multi-select:all-selected"
                                    :params="[numberOfItemsSelected]"></m-i18n>
                        </slot>
                    </template>
                </m-chip-delete>
                <template v-else-if="chipsDisplayMode === 0">
                    <m-chip-delete v-for="item, index in internalValue.slice(0, maxVisibleChips)"
                                   :key="index"
                                   class="m-multi-select__chip"
                                   size="small"
                                   :disabled="disabled"
                                   :readonly="readonly"
                                   @delete="onDelete(index)">
                        <template v-slot:default>
                            <slot name="chips"
                                  :item="item"
                                  :index="index">
                                {{ getChipLabel(item) }}
                            </slot>
                        </template>
                    </m-chip-delete>
                    <span class="m-multi-select__more">
                        <slot name="more">
                            <m-i18n k="m-multi-select:more"
                                    :params="[numberOfItemsSelected - maxVisibleChips]"></m-i18n>
                        </slot>
                    </span>
                </template>
                <m-chip-delete v-else-if="chipsDisplayMode === -1"
                               v-for="item, index in internalValue"
                               :key="index"
                               class="m-multi-select__chip"
                               size="small"
                               :disabled="disabled"
                               :readonly="readonly"
                               @delete="onDelete(index)">
                    <template v-slot:default>
                        <slot name="chips"
                              :item="item"
                              :index="index">
                            {{ getChipLabel(item) }}
                        </slot>
                    </template>
                </m-chip-delete>

                <div class="m-multi-select__icon"
                     slot="suffix"
                     :class="{ 'm--is-open': open }">
                    <m-icon class="m-multi-select__icon-arrow"
                            ref="arrow"
                            name="m-svg__arrow-head-filled--down"
                            size="16px"
                            :title="iconArrowTitle"
                            @keydown.enter.prevent="open = !disabled && !readonly">
                    </m-icon>
                </div>
            </m-input-style>
        </div>
    </template>
    <m-validation-message class="m-multi-select__validation-message"
                          :disabled="disabled"
                          :waiting="waiting"
                          :error="hasError"
                          :valid="isValid"
                          :error-message="errorMessage"
                          :valid-message="validMessage"
                          :helper-message="helperMessage"
                          slot="validation-message"></m-validation-message>
    <template v-if="linkSelectAll"
              v-slot:popup-header>
        <m-select-item @click="onToggleAll"
                       class="m-multi-select__popup-header"
                       :focused="selectAllFocused"
                       :hide-radio-button-mobile="true">
            <m-i18n k="m-multi-select:link-select-all"
                    v-if="!allSelected"></m-i18n>
            <m-i18n k="m-multi-select:link-deselect-all"
                    v-else></m-i18n>
        </m-select-item>
    </template>
    <template v-slot:items="{item , index}">
        <slot name="items"
              :item="item"
              :index="index"><span v-html="item"></span></slot>
    </template>
</m-base-select>
